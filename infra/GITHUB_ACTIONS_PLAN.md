# GitHub Actions CI/CD設定計画

## 概要
TerraformインフラストラクチャのCI/CDパイプラインを構築し、コード品質とセキュリティを自動的に検証する。

## ワークフロー構成

### 1. terraform-plan.yml（PRトリガー）
プルリクエスト時に実行され、変更の影響を事前に確認する。

#### 主な機能
- **変更検出**: 変更されたTerraformディレクトリを自動検出
- **並列実行**: 複数環境の変更を並列でプラン実行
- **フォーマットチェック**: `terraform fmt`による書式検証
- **構文検証**: `terraform validate`による構文チェック
- **実行計画生成**: `terraform plan`の実行と結果の可視化
- **コスト分析**: Infracostによる変更コストの事前確認
- **PRコメント**: 実行結果をPRに自動コメント

#### セキュリティスキャン
- **Checkov**: 設定のベストプラクティスチェック
- **TFSec**: Terraformセキュリティスキャン
- **Terrascan**: ポリシー違反の検出
- **SARIF形式**: スキャン結果をGitHub Security tabに統合

### 2. terraform-apply.yml（メインブランチトリガー）
メインブランチへのマージ時に実行され、実際のインフラストラクチャを更新する。

#### 主な機能
- **承認ゲート**: 本番環境への適用前に手動承認を要求
- **順次実行**: 依存関係を考慮した適用順序
- **ロールバック機能**: 失敗時の自動ロールバック
- **通知**: SlackやEmailでの結果通知
- **ステート管理**: S3バックエンドへの安全な保存

### 3. terraform-drift-detection.yml（定期実行）
スケジュール実行により、実際のインフラとTerraform定義の差分を検出する。

#### 主な機能
- **定期実行**: 毎日または週次でドリフト検出
- **差分レポート**: 検出された差分をIssueとして自動起票
- **アラート**: 重要な差分検出時の即時通知

## 認証とセキュリティ

### AWS認証
- **OIDC Provider**: GitHub ActionsとAWSの信頼関係を確立
- **IAMロール**: 最小権限の原則に基づいたロール設定
- **一時認証**: 長期的な認証情報を保存しない

### シークレット管理
- **GitHub Secrets**: APIキーやトークンの安全な保管
- **SOPS統合**: 暗号化されたシークレットファイルの復号化
- **環境分離**: 環境ごとの独立したシークレット管理

## 実装の要点

### マトリックス戦略
```yaml
# 変更されたディレクトリに対してのみ実行
strategy:
  matrix:
    dir: [detected-changed-directories]
```

### アーティファクト管理
- プランファイルの保存（7日間）
- 実行ログの保存
- セキュリティスキャン結果の保存

### エラーハンドリング
- 各ステップでの`continue-on-error`設定
- 失敗時の詳細ログ出力
- リトライメカニズム

## 必要な事前設定

### GitHub設定
1. **OIDC設定**: AWSとの信頼関係確立
2. **Secrets設定**:
   - `AWS_ACCOUNT_ID`
   - `INFRACOST_API_KEY`
   - `SLACK_WEBHOOK_URL`（オプション）

### AWS設定
1. **IAMロール作成**: `github-actions-terraform`
2. **信頼ポリシー**: GitHub OIDCプロバイダーを信頼
3. **権限ポリシー**: Terraform実行に必要な最小権限

### リポジトリ設定
1. **Branch Protection**: メインブランチの保護
2. **Required Checks**: PR マージ前の必須チェック
3. **CODEOWNERS**: インフラ変更のレビュー必須化

## 段階的導入計画

### Phase 1: 基本的なPlan/Apply
- terraform plan の自動実行
- 手動承認付きの apply

### Phase 2: セキュリティスキャン追加
- Checkov, TFSec, Terrascanの統合
- セキュリティダッシュボードの活用

### Phase 3: コスト管理
- Infracostの導入
- コスト上限アラート

### Phase 4: 高度な自動化
- ドリフト検出の自動化
- 自動ロールバック機能
- ChatOps統合

## メトリクスと監視

### 追跡する指標
- デプロイ頻度
- 変更失敗率
- 平均復旧時間（MTTR）
- リードタイム

### アラート設定
- プラン失敗時
- セキュリティ違反検出時
- コスト閾値超過時
- ドリフト検出時

## 期待される効果

1. **品質向上**: 自動テストによるエラーの早期発見
2. **セキュリティ強化**: 継続的なセキュリティスキャン
3. **コスト最適化**: 変更前のコスト影響確認
4. **運用効率化**: 手動作業の削減と標準化
5. **監査対応**: 変更履歴の完全な記録

## 注意事項

- 大規模な変更は段階的に実施
- 本番環境への適用は営業時間外を推奨
- バックアップとロールバック計画の準備
- チーム全体でのワークフロー理解の徹底